# 日报邮件查看详情功能 - 使用指南

## 📖 功能说明

用户收到 AI 行业日报邮件后，可以通过邮件中的链接：
1. **查看完整详情** - 跳转到 Web 页面查看当天完整报告
2. **浏览历史日报** - 查看所有历史日报列表

## 🎯 使用场景

### 场景 1: 快速浏览
- 用户在邮箱中快速浏览当天摘要
- 对某个话题感兴趣，点击"查看完整详情"
- 在 Web 页面查看完整的推文列表和详细分析

### 场景 2: 深度阅读
- 用户想要查看更多推文详情
- 点击邮件中的链接进入详情页
- 可以看到所有推文的完整内容、互动数据等

### 场景 3: 历史回顾
- 用户想要查看之前的日报
- 点击"浏览历史日报"链接
- 进入首页，浏览所有历史日报

## 🔗 链接位置

### 1. 邮件头部（主要入口）
```
┌─────────────────────────────────┐
│   🤖 AI 行业日报                │
│   2026年02月10日                │
│   5 分钟了解 AI 行业关键变化     │
│                                 │
│   ┌─────────────────────┐      │
│   │ 📖 查看完整详情      │      │ ← 主按钮
│   └─────────────────────┘      │
│   在线查看完整报告 · 浏览历史日报│
└─────────────────────────────────┘
```

### 2. 邮件底部（次要入口）
```
┌─────────────────────────────────┐
│   🤖 由 Claude AI 自动生成       │
│   基于 150 条推文 · 精选 10 个关键事件│
│                                 │
│   ┌─────────────────────┐      │
│   │ 🌐 在线查看完整报告  │      │ ← 次按钮
│   └─────────────────────┘      │
│                                 │
│   📚 浏览历史日报               │ ← 文字链接
│                                 │
│   Signal > Noise · Insight > Summary│
└─────────────────────────────────┘
```

## 📱 用户流程

```
收到邮件
   ↓
快速浏览摘要
   ↓
点击"查看完整详情"
   ↓
跳转到 Web 详情页
   ↓
┌─────────────────────────┐
│ 选项 1: 查看完整报告     │
│ - 所有推文详情          │
│ - 互动数据              │
│ - 完整分析              │
└─────────────────────────┘
   ↓
┌─────────────────────────┐
│ 选项 2: 浏览历史日报     │
│ - 返回首页              │
│ - 查看所有历史记录       │
│ - 选择其他日期          │
└─────────────────────────┘
```

## 🛠️ 技术实现

### 后端配置

#### 1. 环境变量设置
在 `backend/.env` 文件中配置：

```bash
# 前端 URL（必须配置）
FRONTEND_URL=http://localhost:3000  # 开发环境
# FRONTEND_URL=https://your-domain.com  # 生产环境

# 邮件服务配置
RESEND_API_KEY=your-resend-api-key
EMAIL_FROM=noreply@yourdomain.com
EMAIL_TO=your-email@example.com
ENABLE_EMAIL=True
```

#### 2. URL 生成逻辑
```python
# 在 email_service_v2.py 中
detail_url = f"{settings.frontend_url}/summary/{summary.url_slug}"
history_url = settings.frontend_url
```

### 前端路由

#### 详情页路由
- **路径**: `/summary/[id]`
- **文件**: `frontend/app/summary/[id]/page.tsx`
- **支持**:
  - 按 ID 访问: `/summary/123`
  - 按 slug 访问: `/summary/2026-02-10`

#### 首页路由
- **路径**: `/`
- **文件**: `frontend/app/page.tsx`
- **功能**: 显示所有历史日报列表，支持分页

## 🧪 测试方法

### 方法 1: 预览邮件模板
```bash
cd backend
source venv/bin/activate
python scripts/preview_email.py
open email_preview.html
```

### 方法 2: 发送测试邮件
```bash
cd backend
source venv/bin/activate
python scripts/test_email_with_links.py
```

### 方法 3: 手动测试链接
1. 启动后端服务
```bash
cd backend
source venv/bin/activate
uvicorn app.main:app --reload
```

2. 启动前端服务
```bash
cd frontend
npm run dev
```

3. 访问测试链接
- 详情页: http://localhost:3000/summary/2026-02-10
- 首页: http://localhost:3000

## ✅ 验证清单

### 邮件内容检查
- [ ] 邮件头部有"📖 查看完整详情"按钮
- [ ] 按钮样式正确（白色背景，蓝色文字）
- [ ] 头部有提示文字"在线查看完整报告 · 浏览历史日报"
- [ ] 邮件底部有"🌐 在线查看完整报告"按钮
- [ ] 邮件底部有"📚 浏览历史日报"链接

### 链接功能检查
- [ ] 点击头部按钮能跳转到详情页
- [ ] 点击底部按钮能跳转到详情页
- [ ] 点击历史链接能跳转到首页
- [ ] URL 格式正确（包含正确的域名和 slug）

### 页面显示检查
- [ ] 详情页能正常加载
- [ ] 显示完整的日报内容
- [ ] 显示所有推文列表
- [ ] 可以返回首页
- [ ] 首页显示历史日报列表

### 移动端检查
- [ ] 邮件在手机上显示正常
- [ ] 按钮在手机上易于点击
- [ ] 链接在手机上能正常跳转
- [ ] 详情页在手机上显示正常

## 🔧 故障排查

### 问题 1: 链接无法跳转
**原因**: FRONTEND_URL 配置错误
**解决**: 检查 `.env` 文件中的 FRONTEND_URL 配置

### 问题 2: 详情页 404
**原因**: 前端服务未启动或路由配置错误
**解决**:
1. 确保前端服务正在运行
2. 检查 URL slug 是否正确
3. 检查数据库中是否有对应的日报记录

### 问题 3: 邮件中链接显示为纯文本
**原因**: 邮件客户端不支持 HTML
**解决**: 大多数现代邮件客户端都支持 HTML，建议使用 Gmail、Outlook 等

### 问题 4: 生产环境链接错误
**原因**: 生产环境未更新 FRONTEND_URL
**解决**: 在生产环境的 `.env` 文件中设置正确的域名

## 📊 数据流程

```
┌─────────────────┐
│  定时任务        │
│  (每日 8:00)    │
└────────┬────────┘
         ↓
┌─────────────────┐
│  生成日报        │
│  - 收集推文      │
│  - AI 分析       │
│  - 生成摘要      │
└────────┬────────┘
         ↓
┌─────────────────┐
│  保存到数据库    │
│  - DailySummary │
│  - url_slug     │
└────────┬────────┘
         ↓
┌─────────────────┐
│  发送邮件        │
│  - 生成 HTML     │
│  - 包含链接      │
│  - 发送给用户    │
└────────┬────────┘
         ↓
┌─────────────────┐
│  用户收到邮件    │
│  - 查看摘要      │
│  - 点击链接      │
└────────┬────────┘
         ↓
┌─────────────────┐
│  访问 Web 页面   │
│  - 详情页        │
│  - 历史列表      │
└─────────────────┘
```

## 🎨 样式说明

### 主按钮样式
- **背景**: 白色 (#FFFFFF)
- **文字**: 蓝紫色 (#667eea)
- **圆角**: 8px
- **阴影**: 0 4px 12px rgba(0,0,0,0.15)
- **内边距**: 14px 32px

### 次按钮样式
- **背景**: 半透明白色 rgba(255,255,255,0.1)
- **文字**: 白色
- **圆角**: 6px
- **边框**: 1px solid rgba(255,255,255,0.2)
- **内边距**: 12px 28px

### 文字链接样式
- **颜色**: rgba(255,255,255,0.6)
- **下划线**: 1px solid rgba(255,255,255,0.3)
- **字号**: 14px

## 📈 后续优化建议

### 短期优化
1. **添加 UTM 参数** - 追踪邮件点击来源
2. **个性化问候** - 根据用户名个性化邮件内容
3. **深度链接** - 支持直接跳转到特定推文

### 中期优化
1. **邮件偏好设置** - 允许用户自定义邮件频率
2. **分享功能** - 在详情页添加分享按钮
3. **收藏功能** - 允许用户收藏感兴趣的日报

### 长期优化
1. **个性化推荐** - 根据用户兴趣推荐相关内容
2. **多语言支持** - 支持英文、中文等多种语言
3. **移动应用** - 开发移动端 App

## 🔐 安全注意事项

1. **HTTPS**: 生产环境必须使用 HTTPS
2. **URL 验证**: 确保 URL 参数经过验证
3. **访问控制**: 考虑添加访问权限控制
4. **速率限制**: 防止恶意访问

## 📞 支持

如有问题，请查看：
- 项目文档: `backend/README.md`
- 邮件功能总结: `backend/EMAIL_FEATURE_SUMMARY.md`
- 测试脚本: `backend/scripts/test_email_with_links.py`
